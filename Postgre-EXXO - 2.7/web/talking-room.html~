<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" href="alloy/build/aui-skins/core/css/main.css" type="text/css" /> 
<link rel="stylesheet" href="alloy/build/aui-skins/classic/css/custom.css" type="text/css" /> 


<style type="text/css">
.aui-widget-bd  {
overflow-y: hidden;
overflow-x: hidden;
position:relative;

}

#scroller  {
overflow-y: scroll;
overflow-x: hidden;
position:relative;

}

#sch-container {
}
table#main, table#main tr {
width:100%;
height:1600px;
}

table#main {
border:0;
height:1600px;
}
table#main td#first {
width:50px;
height:1600px;
vertical-align: top;
background-color:#426487;

}

td#first div {

width: 50px;
height: 100px;
text-align:right;
position: relative;
}
td#first div span {
font-size:8pt;
color:#6b6b6b;
margin: 4px;

}

td#second {
width:750px;
background-image: url(bgDay.png);
background-repeat: repeat;
height:1600px;
overflow:hidden;
}


table#main,table#main tbody {
width:100%;
height:1600px;
overflow:hidden;
}

.sch-container-wide table#main td#first {
width:50px;
height:1600px;

}


.sch-container-wide td#first div span {
font-size:8pt;
color:white;
margin: 4px;
}

.sch-container-wide td#second {
width:750px;
background-image: url(bgDay.png);
background-repeat: repeat;
height:1600px;
}

.event-day{
position: absolute;
font-size:8pt;
background-color: #f6e4b2;
color:#6b6b6b;
height:25px;
width:750px;
line-height:12px;
display:block;
visibility:visible;
}


.event-day div.eventsHeader{
color: black;
width:100%;
height:12px;
background-color:#f0c96e;
}



.editor {
color:black;
position:relative;
width:100%;
height:13px;
}


.myPanel-content {
width:30em;
}
.myPanel-content  input{
width:20em;


}

.event-day .aui-widget-bd{
overflow: hidden;

}

.myPanel-content .aui-widget-bd{
overflow: hidden;

}

.close-hd {
position:absolute;
top:6px;
right:4px;
}

#rightBig {
position:absolute;
width:400px;
left:820px;
top:50px;
}

span.blue {
color:blue;
}

.calendar-icon {
	font-size:15px;
	left:820px;
	line-height:25px;
	position:absolute;
	top:0px;
}
#arrows {
top:5px;
position:absolute;

left:860px;
}

span.red {
color:red;
}

</style>
<script type="text/javascript" charset="utf-8" src="alloy/build/yui/yui-min.js"></script>
<script type="text/javascript" charset="utf-8" src="alloy/build/aui-base/aui-base-min.js"></script>
</head>

<body>
<div id="sch-container" class="sch-container-wide"></div><div id="rightBig"><span id="date"></span><div id="right"></div></div><div class="calendar-icon"> 
	<button class="aui-button aui-button-content aui-state-default"> 
		<span class="aui-icon aui-icon-calendar"></span> 
	</button> 
	
</div> 
<div id="arrows"></div>
  
<script type="text/javascript" charset="utf-8">
AUI().ready('aui-calendar-base','dataschema','dump','aui-overlay', 'aui-node', 'event-custom','aui-editable', 'aui-resize','dd-constrain', 'dd-scroll', 'aui-form-textfield', 'datatype-date', 'datatype-xml','aui-io-request', function(A) {
var myHeight=document.body.clientHeight-(document.body.clientHeight%25);
var Year;
var Day;
var Month;
var eventsArr=new Array();
var now=new Date();
Year=now.getFullYear()
Month=now.getMonth();
Day=now.getDate();
//var toDay=new Date(Year, Month, Day);
var scrollerTop;
A.DataType.Date.Locale['ru'] = A.merge(A.DataType.Date.Locale, {
"a":["вс","пн","вт","ср","чт","пт","сб"],
"A":["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"],
"b":["янв.","февр.","марта","апр.","мая","июня","июля","авг.","сент.","окт.","нояб.","дек."],
"B":["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],
"c":"%a, %d %b %Y %k:%M:%S %Z","p":["AM","PM"],
"P":["am","pm"],
"x":"%d.%m.%y",
"X":"%k:%M:%S"
    });




//alert(Year+' '+Month+' '+Day);
function onScrollerScroll(e){
scrollerTop=-A.one('#second').getY()+(A.one('#second').getY()%25);

}



var sch = new A.Overlay({
		
		bodyContent: '<table id="main"> <tbody><tr><td id="first"></td><td id="second"></td></tr></tbody></table>',
		xy: [ 0, 0 ],
		width: 800,
		height: myHeight
	})
	.render('#sch-container');
A.one('table#main').get('parentNode').setAttribute('id','scroller');

A.one('td#second').setStyle('height','1600px');
A.one('#scroller').setStyle('height',myHeight);//IE
scrollerTop=A.one('#second').get('region').top;
A.one('table#main').setStyle('position','relative');

A.one('td#second').setStyle('vertical-align','top');

for(var i=0; i<16; i++){
var timer=i+8;
A.Node.create("<div class='timer'><span>"+timer+"-00"+" </span></div>").appendTo("td#first");
}

xmlR();
var onresise=function(e){
var newHeight = document.body.clientHeight;
A.one("#sch-container .aui-widget").setStyle("height",newHeight);
A.one(".aui-widget-bd ").setStyle("height",newHeight);
}
function Timer(o){
this.o=o;
this.time=topToTime;
this.long=heightToTime;
this.fin=heightToFin;
this.longToString=longToString;
}
function longToString(){
var h=Math.floor(this.long()/60);
var m=this.long()%60;
var str=h+'ч. '+m+' мин.';
if (h==0){str=m+' мин.';};
if (m==0){str=h+'ч. ';};
return(str);
}
function heightToFin(){
var fin=this.time();
fin.setMinutes(this.time().getMinutes()+this.long());
return(fin);
}
function topToTime(){
var h=parseInt(this.o.getStyle("top").replace(/px/g,""),10);
var timeWhole=16/1600*h+8;
var timeH=Math.floor(timeWhole);
var timeM=Math.round((timeWhole-timeH)*60);
var timeMstep15=Math.floor(timeM/15)*15;
var time=new Date(Year, Month, Day,timeH,timeMstep15,0);
return(time);
}
function heightToTime(){
var long=Math.round(parseInt(this.o.getStyle("height").replace(/px/g,""),10)*0.6);
return(long);
}

var firstTime="Задайте событие";
var GETxyWide=function(e){


if(e.target.test('td#second')){
var timePlace=e.clientY-A.one("#second").getY();
var timeWhole=16/1600*timePlace+8;
var timeH=Math.floor(timeWhole);
var timeM=Math.round((timeWhole-timeH)*60);
var timeMstep15=Math.floor(timeM/15)*15;
var timePlacestep15=Math.round((timeMstep15/60+timeH-8)/16*1600);
var valueEv=firstTime;
var DateEv=new Date(Year, Month, Day,timeH,timeMstep15,0);
var finEv=new Date(Year, Month, Day,timeH,timeMstep15+15,0);
SuperEv(DateEv,finEv,timePlacestep15,25,valueEv,true);

}
}
function SuperEv(DateEv,finEv,timePlacestep15,height,valueEv,showOnRender){
//alert('1');
var events = A.Node.create("<div class='event-day'></div>");
//A.one('#second').append(events);
var inno=A.Node.create('<div class="eventsHeader">'+A.DataType.Date.format(DateEv,{format:'%H:%M'})+' - '+A.DataType.Date.format(finEv,{format:'%H:%M'})+'</div>');
var editor=A.Node.create('<div class="editor">'+valueEv+'</div>');
var ev=new A.Overlay({
boundingBox: events,
bodyContent: editor,
y:timePlacestep15,
headerContent:inno
}).render('#second');
ArrPlus(events);

var tdSecondWidth=A.one('td#second').getComputedStyle('width');
//var scrollerWidth=A.one('#scroller').get('parentNode').getComputedStyle('width');
//var scrollerWidth=A.one('#sch-container').getComputedStyle('width');//не правильно но работает
var scrollerWidth=document.body.clientWidth;//?
//var rightGutter=parseInt(scrollerWidth,10)-parseInt(tdSecondWidth,10)-50;
var rightGutter=parseInt(scrollerWidth,10)-parseInt(A.one('#main').getComputedStyle('width'),10);
var bottomGutter=25;
//events.setStyle("width",tdSecondWidth);
events.setStyle("width",parseInt(A.one('#main').getComputedStyle('width'),10)-parseInt(A.one('#first').getComputedStyle('width'),10));
events.setStyle("top",timePlacestep15);
events.setStyle("left",'auto');
events.setStyle("height",height+'px');
//alert(scrollerWidth);
//events.setY(timePlacestep15);
events.unselectable();
var instance = new A.Resize({
node: events,
proxy: false,
preserveRatio: false,
wrap: false,
tickY:25,
maxHeight: 1600,
maxWidth: 750,
minHeight: 25,
handles: 'b',

on: {"resize:resize":function(event){
var t=new Timer(events);
inno.text(t.longToString());
},
"resize:end":function(event){
var t=new Timer(events);
inno.text(A.DataType.Date.format(t.time(),{format:'%H:%M'})+' - '+A.DataType.Date.format(t.fin(),{format:'%H:%M'}));
xmlWR();
},
"resize:start":function(event){
var listOfEvents=A.all(".event-day");
var Near=1600;
listOfEvents.each(function(){
var k=parseInt(this.getStyle("top").replace(/px/g,""),10);
if(k>parseInt(events.getStyle("top").replace(/px/g,""),10)&&k<Near) Near=k;
});

maxH=Near-parseInt(events.getStyle("top").replace(/px/g,""),10);
instance.setAttrs({maxHeight: maxH})

}

}
});

var myTopik;


var dd=new A.DD.Drag({
node: events,
on:{'drag:drag':function(event){
	var t=new Timer(events);

inno.text(A.DataType.Date.format(t.time(),{format:'%H:%M'}));
var kTop=parseInt(events.getStyle("top").replace(/px/g,""),10);
var kHeight=parseInt(events.getStyle("height").replace(/px/g,""),10);

		},
		'drag:end':function(event){
			var listOfEvents=A.all(".event-day");
			var count=1;
			var myTop=parseInt(events.getStyle("top").replace(/px/g,""),10);
			var myHeight=parseInt(events.getStyle("height").replace(/px/g,""),10);
				listOfEvents.each(function(){
				var kTop=parseInt(this.getStyle("top").replace(/px/g,""),10);
				var kHeight=parseInt(this.getStyle("height").replace(/px/g,""),10);
				if((myTop<=kTop&&myTop+myHeight>=kTop+kHeight)||(myTop>=kTop&&myTop+myHeight<=kTop+kHeight)||
				(myTop<=kTop&&myTop+myHeight>kTop)||(kTop<=myTop&&kTop+kHeight>myTop)){count++}
				});
				if(count>2){events.setStyle("top",myTopik);}
				},
		'drag:start':function(event){myTopik=parseInt(events.getStyle("top").replace(/px/g,""),10);

		    }, 'drag:mouseDown':function(event){
var ScreenHeight=document.body.clientHeight-(document.body.clientHeight%25);
//alert(ScreenHeight+'  '+navigator.userAgent);
//var ScreenHeight=A.one('#scroller').getStyle('height');
if(navigator.userAgent.indexOf('Opera')!=-1){ScreenHeight=ScreenHeight-1}

scrollerTop=-A.one('#second').getY()+(A.one('#second').getY()%25);
var templDiv=A.Node.create('<div></div>');
templDiv.setStyles({top:scrollerTop,width:'1px',height:ScreenHeight, position:'absolute','z-index':999,border:0});

A.one('#scroller').appendChild(templDiv);
templDiv.scrollIntoView();
templDiv.remove();
}
		

},
after:{'drag:end':function(event){
var t=new Timer(events);

inno.text(A.DataType.Date.format(t.time(),{format:'%H:%M'})+' - '+A.DataType.Date.format(t.fin(),{format:'%H:%M'}));
xmlWR();
}}
}).plug(A.Plugin.DDConstrained, {constrain2node:'#scroller',tickY:25,gutter:'25 '+rightGutter+' '+bottomGutter+' 50'}).plug(A.Plugin.DDNodeScroll,{node:A.one('#scroller'),buffer:50});
//}).plug(A.Plugin.DDConstrained, {constrain2node:'#second',tickY:25,gutter:'25 0 25 0',cacheRegion:false}).plug(A.Plugin.DDNodeScroll,{node:A.one('#scroller'),buffer:50});




var contextP = new A.OverlayContextPanel({
headerContent: '<span class="contentP-hd">введите событие</span><span class="aui-button-icon aui-icon aui-icon-minus close-hd" title="Закрыть"></span>',
bodyContent: '<span class="contentP-bd"><span class="contentP-Input"></span></span>',
footerContent:'<span class="contentP-ft"><span class="contentP-Tools"></span></span>',
cssClass: 'myPanel',
showArrow:false,
centered:true,
trigger: editor,
focused: true,
cancellableHide: true,
hideDelay: 200,
hideOnDocumentClick: true,
anim: {
show: {
duration: .9
},
hide: {
duration: .2
}
},
//on :{'visibleChange':function(event){contextP.get('bodyContent').one('input').focus();}}
after:{'render':function(event){if(showOnRender==true){this.show();}}}
}).render();
var valueInp=valueEv;
if(valueInp==firstTime) {valueInp=''};
var textfield1 = new A.Textfield({
		selectOnFocus: true,
		value: valueInp,
		focused: true
	}).render(contextP.get('bodyContent').one('span.contentP-Input'));
var closeContextP=function(event){contextP.hide();xmlWR();};
var toolbarContextP = new A.Toolbar(
		{
			activeState: true,
			children: [
				{label: 'Сохранить',icon: 'check',handler: {fn: function(e){contextP.hide();xmlWR();}, context: toolbarContextP, type: 'click'}},
				{label: 'Удалить',icon: 'close',handler: {fn: function(e){ ArrMinus(events);ev.destroy();contextP.hide();contextP.get('contentBox').get("parentNode").empty(); xmlWR(); contextP=null; A.Node.all('.myPanel').each(function(){if(!this.hasChildNodes()){this.remove();}})}, type: 'click'}},
				{label: 'Править',icon: 'pencil'}
			]
		}
	).render(contextP.get('footerContent').one('span.contentP-Tools'));

//if(showOnRender){xmlWR();}
xmlWR();
A.on("change",function(e){editor.text(contextP.get('bodyContent').one('input').get('value'))},contextP.get('bodyContent').one('input'));
A.on("click",closeContextP ,'span.close-hd');

}
function ArrPlus(node){eventsArr[eventsArr.length]=node;}

function ArrMinus(node){
for(var i=0;i<eventsArr.length;i++){
if(eventsArr[i]===node){eventsArr[i]=null;}

}

}

function xmlWR(){
var string='<xml><calendar><date year="'+Year+'" month="'+Month+'" day="'+Day+'">';

var t;
var list='';
var count=0;
var eventsArrS = new Array();
var k=0;
for(var j=0; j<eventsArr.length; j++) {
if(eventsArr[j]){
eventsArrS[k]=eventsArr[j];
k++;
}
}


eventsArr=eventsArrS.sort(function(a,b){
var t1=new Timer(a);
var t2=new Timer(b);
return t1.time()-t2.time() });
for(var i=0;i<eventsArr.length;i++){
if(eventsArr[i]){
count++;
t=new Timer(eventsArr[i]);
var text=eventsArr[i].one('.editor').text();
if (text=='Задайте событие'){text='Событие не задано'}
string+='<item><hours>'+t.time().getHours()+'</hours><minutes>'+t.time().getMinutes()+'</minutes><name>'+text+'</name><long>'+t.long()+'</long></item>'
list+='<span class="blue">'+A.DataType.Date.format(t.time(),{format:'%H:%M'})+'-'+A.DataType.Date.format(t.fin(),{format:'%H:%M'})+'</span>   '+text+'<br/>';
}
}

var listik=A.Node.create(list);
A.one('#right').empty().append(listik);

string+='</date></calendar></xml>';
var user='10';
var date=Year+'-'+(Month+1)+'-'+Day;
A.io.request('Calendar', {
		data: {
			user: user,
			date: date,
			xml: string
		},
		method: 'post',
		headers:{'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'}
	});
}

function xmlR(){

/////////////////////////
var time=new Date(Year,Month,Day);
A.one('#date').empty();
A.Node.create('<b>'+A.DataType.Date.format(time,{format:'%A,  %e %b', locale:'ru'})+'</b><br/>').appendTo(A.one('#date'));
//////////////////////




var io=A.io.request('CalendarOut', {
			dataType: 'xml',
			cache: false,
			data: {
			user: '10',
			date: Year+'-'+(Month+1)+'-'+Day
			
		},
		method: 'post',

			on: {
				success: function(event, id, xhr) {

				   var Datas=this.get('responseData');

				  var mySchema = {
    metaFields: {Year:"//@year", Month:"//@month", Day:"//@day"},
    resultListLocator: "item", 
   resultFields: [{key:"Hours", locator:"hours"}, {key:"Minutes", locator:"minutes"}, {key:"Long", locator:"long"}, {key:"Name", locator:"name"}]
};
var myOutput = A.DataSchema.XML.apply(mySchema, Datas); 
//alert(A.dump(myOutput));
//var Year=myOutput.meta.Year;
//var Month=myOutput.meta.Month;
//var Day=myOutput.meta.Day;
if(myOutput.results.length==0){

var loading = A.Node.create('<span class='red'>Пока ничего не назначено</span>');
A.one('#right').append(loading);

}
for(var i=0;i<myOutput.results.length;i++){
var Hours=parseInt(myOutput.results[i].Hours,10);
var Minutes=parseInt(myOutput.results[i].Minutes,10);
var Long=parseInt(myOutput.results[i].Long,10);
var Name=myOutput.results[i].Name;
var time=new Date(Year,Month,Day,Hours,Minutes,0);
var Minfin=Minutes+Long;

var timeFin=new Date(Year,Month,Day,Hours,Minfin,0);
var top=Hours*100+(Minutes/0.6)-800;
var height=Long/0.6;
SuperEv(time,timeFin,top,height,Name,false);
}

				}
			}
		});
}
 
var calendar2 = new A.Calendar({
		trigger: '.aui-button',
		locale: 'ru',
		firstDayOfWeek: 1,
		on: {
			select: function(event) {
//				alert( (event.date.detailed[0].year));
A.all('.myPanel').remove();
A.all('.event-day').remove();
eventsArr=[];
A.one('#right').empty();

Year= event.date.detailed[0].year;
Month= event.date.detailed[0].month;
Day= event.date.detailed[0].day;
this.hide();

xmlR();


			}
		}
	})
	.render();

var arrows = new A.Toolbar(
		{
			activeState: false,
			children: [
				{icon: 'circle-arrow-l',handler: {fn: function(e){
				Day--;
				A.all('.myPanel').remove();
				A.all('.event-day').remove();
				eventsArr=[];
				A.one('#right').empty();
				xmlR();
}, type: 'click'}},
				{icon: 'star',handler: {fn: function(e){
				
				Year=now.getFullYear()
				Month=now.getMonth();
				Day=now.getDate();
				A.all('.myPanel').remove();
				A.all('.event-day').remove();
				eventsArr=[];
				A.one('#right').empty();
				xmlR();
}, type: 'click'}},
				{icon: 'circle-arrow-r',handler: {fn: function(e){
				Day++;
				A.all('.myPanel').remove();
				A.all('.event-day').remove();
				eventsArr=[];
				A.one('#right').empty();
				xmlR();
}, type: 'click'}}
			]
		}
	).render('#arrows');




 var b=A.one("body");
 A.on("windowresize", onresise, b );
 A.on("click",GETxyWide,"#second");
 A.on("scroll",onScrollerScroll,"#scroller");

});
</script>

</body></html>
